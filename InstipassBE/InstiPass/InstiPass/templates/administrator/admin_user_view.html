{% extends "base.html" %}
{% block title %}User Management{% endblock %}
{% block content %}
    {% include "admin_nav.html" %}
    <style>
        /* Custom colors for user roles */
        .text-indigo {
            color: #6610f2;
        }
        .text-purple {
            color: #6f42c1;
        }
        .text-pink {
            color: #d63384;
        }
        .text-teal {
            color: #20c997;
        }
        
        /* Blacklisted user styling */
        .blacklisted-user {
            background-color: rgba(220, 53, 69, 0.1);
            border-left: 4px solid #dc3545;
        }
        
        .blacklisted-badge {
            background-color: #dc3545;
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }
        
        /* Dark mode styles for this specific page */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #121212;
                color: #e0e0e0;
            }
            
            h1, h2, h3, h4, h5, h6 {
                color: #e0e0e0;
            }
            
            .text-muted {
                color: #a0a0a0 !important;
            }
            
            .card {
                background-color: #1e1e1e;
                border-color: #333333;
            }
            
            .card-header {
                background-color: #2d2d2d !important;
                border-color: #333333;
            }
            
            .table {
                color: #e0e0e0;
            }
            
            .table-hover tbody tr:hover {
                background-color: rgba(255, 255, 255, 0.05);
            }
            
            .blacklisted-user {
                background-color: rgba(220, 53, 69, 0.2);
                border-left: 4px solid #dc3545;
            }
            
            .form-control, .form-select {
                background-color: #2d2d2d;
                border-color: #444444;
                color: #e0e0e0;
            }
            
            .input-group-text {
                background-color: #2d2d2d;
                border-color: #444444;
                color: #a0a0a0;
            }
            
            .btn-outline-secondary {
                color: #a0a0a0;
                border-color: #444444;
            }
            
            .btn-outline-secondary:hover {
                background-color: #2d2d2d;
                color: #e0e0e0;
            }
            
            .btn-outline-primary {
                color: #3d8bfd;
                border-color: #3d8bfd;
            }
            
            .btn-outline-primary:hover {
                background-color: rgba(61, 139, 253, 0.2);
                color: #e0e0e0;
            }
            
            .btn-outline-danger {
                color: #dc3545;
                border-color: #dc3545;
            }
            
            .btn-outline-danger:hover {
                background-color: rgba(220, 53, 69, 0.2);
                color: #e0e0e0;
            }
            
            .btn-outline-warning {
                color: #ffc107;
                border-color: #ffc107;
            }
            
            .btn-outline-warning:hover {
                background-color: rgba(255, 193, 7, 0.2);
                color: #e0e0e0;
            }
            
            .btn-outline-info {
                color: #0dcaf0;
                border-color: #0dcaf0;
            }
            
            .btn-outline-info:hover {
                background-color: rgba(13, 202, 240, 0.2);
                color: #e0e0e0;
            }
            
            /* Adjust opacity for better visibility */
            .bg-opacity-10 {
                --bs-bg-opacity: 0.2 !important;
            }
            
            /* Ensure table headers are visible */
            .table-dark {
                background-color: #2d2d2d;
            }
            
            /* Ensure the close button is visible */
            .btn-close {
                filter: invert(1) grayscale(100%) brightness(200%);
            }
            
            /* Custom colors for dark mode */
            .text-indigo {
                color: #a370f7 !important;
            }
            
            .text-purple {
                color: #b76eff !important;
            }
            
            .text-pink {
                color: #ea77ad !important;
            }
            
            .text-teal {
                color: #20c997 !important;
            }
            
            /* User name links */
            .user-name {
                color: #e0e0e0 !important;
            }
            
            .user-name:hover {
                color: #3d8bfd !important;
            }
            
            /* Card shadows */
            .shadow-sm {
                box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.5) !important;
            }
            
            /* Modal styling */
            .modal-content {
                background-color: #1e1e1e;
                border-color: #333333;
            }
            
            .modal-header {
                border-color: #333333;
            }
            
            .modal-footer {
                border-color: #333333;
            }
        }
    </style>
    <div class="container-fluid py-4">
        <!-- Messages -->
        {% if messages %}
            <div class="mb-4">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        <i class="bi bi-info-circle me-2"></i>{{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h2 mb-1">
                            <i class="bi bi-people text-primary me-3"></i>User Management
                        </h1>
                        <p class="text-muted mb-0">Manage and monitor system users</p>
                    </div>
                    <div class="d-flex gap-2">
                        <span class="badge bg-primary fs-6">Total: {{ users|length }}</span>
                        <button class="btn btn-outline-secondary" onclick="exportData()">
                            <i class="bi bi-download me-1"></i>Export
                        </button>
                    </div>
                </div>
            </div>
        </div>

        {% if users %}
            <!-- Search and Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label text-muted small">Search Users</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="searchUsers" 
                                       placeholder="Search by username, email, role...">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label text-muted small">Role</label>
                            <select class="form-select" id="roleFilter">
                                <option value="">All Roles</option>
                                
                                    <option value="institution">Institution</option>
                                    <option value="">Admin</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label text-muted small">Status</label>
                            <select class="form-select" id="statusFilter">
                                <option value="">All Users</option>
                                <option value="active">Active</option>
                                <option value="blacklisted">Blacklisted</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label text-muted small">Sort By</label>
                            <select class="form-select" id="sortBy">
                                <option value="username">Username A-Z</option>
                                <option value="username-desc">Username Z-A</option>
                                <option value="role">Role</option>
                                <option value="email">Email</option>
                                <option value="id">ID</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                <i class="bi bi-times me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Grid/List View Toggle -->
            <div class="card">
                <div class="card-header bg-white border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Users Directory</h5>
                        <div class="d-flex gap-2">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm active" id="listView">
                                    <i class="bi bi-list"></i> List
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="cardView">
                                    <i class="bi bi-th"></i> Cards
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- List View -->
                <div class="card-body p-0" id="listViewContainer">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="usersTable">
                            <thead class="table-dark sticky-top z-2">
                                <tr>
                                    <th class="px-3 py-3" style="width: 60px;">
                                        <small>ID</small>
                                    </th>
                                    <th class="px-3 py-3" style="width: 200px;">
                                        <small>Username</small>
                                    </th>
                                    <th class="px-3 py-3" style="width: 200px;">
                                        <small>Email</small>
                                    </th>
                                    <th class="px-3 py-3" style="width: 120px;">
                                        <small>Role</small>
                                    </th>
                                    <th class="px-3 py-3" style="width: 100px;">
                                        <small>Status</small>
                                    </th>
                                    <th class="px-3 py-3" style="width: 150px;">
                                        <small>Permissions</small>
                                    </th>
                                    <th class="px-3 py-3" style="width: 120px;">
                                        <small>Groups</small>
                                    </th>
                                    <th class="px-3 py-3" style="width: 150px;">
                                        <small>Actions</small>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr class="user-row {% if not user.is_active %}blacklisted-user{% endif %}" 
                                    data-username="{{ user.username|lower }}" 
                                    data-email="{{ user.email|lower }}" 
                                    data-role="{{ user.role|lower }}"
                                    data-status="{% if user.is_active %}active{% else %}blacklisted{% endif %}">
                                    <td class="px-3 py-3">
                                        <small class="text-muted">#{{ user.id }}</small>
                                    </td>
                                    <td class="px-3 py-3">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-2">
                                                <i class="bi bi-person text-white"></i>
                                            </div>
                                            <div>
                                                <div class="fw-medium user-name">{{ user.username }}</div>
                                                {% if not user.is_active %}
                                                    <span class="blacklisted-badge">BLACKLISTED</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-3 py-3">
                                        <div class="text-muted small">
                                            <i class="bi bi-envelope me-1"></i>{{ user.email }}
                                        </div>
                                    </td>
                                    <td class="px-3 py-3">
                                        {% if user.is_superuser %}
                                        <span class="badge bg-info bg-opacity-10 text-info border border-info">
                                            admin
                                        </span>
                                        {% else %}
                                        <span class="badge bg-info bg-opacity-10 text-info border border-info">
                                            {{ user.role|title }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="px-3 py-3">
                                        {% if user.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-danger">Blacklisted</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-3 py-3">
                                        <div class="text-muted small">
                                            {% if user.permissions.all %}
                                                {{ user.permissions.count }} permission{{ user.permissions.count|pluralize }}
                                            {% else %}
                                                No permissions
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="px-3 py-3">
                                        <div class="text-muted small">
                                            {% if user.groups.all %}
                                                {{ user.groups.count }} group{{ user.groups.count|pluralize }}
                                            {% else %}
                                                No groups
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="px-3 py-3">
                                        <div class="d-flex gap-3">
                                            {% if user.is_active %}
                                                <button class="btn btn-outline-danger btn-sm" 
                                                        onclick="openBlacklistModal('{{ user.email }}', '{{ user.username }}', 'blacklist')"
                                                        title="Blacklist User">
                                                    <i class="bi bi-ban"></i>
                                                </button>
                                            {% else %}
                                                <button class="btn btn-outline-warning btn-sm" 
                                                        onclick="openBlacklistModal('{{ user.email }}', '{{ user.username }}', 'unblacklist')"
                                                        title="Unblacklist User">
                                                    <i class="bi bi-check-circle"></i>
                                                </button>
                                            {% endif %}
                                            
                                            <a href="{% url 'delete_user' user.id %}?next=/super/usermanagement">
                                            <button class="btn btn-sm btn-danger delete-btn" title="Delete User">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Card View -->
                <div class="card-body d-none" id="cardViewContainer">
                    <div class="row g-3" id="usersCards">
                        {% for user in users %}
                        <div class="col-md-6 col-lg-4 user-card {% if not user.is_active %}blacklisted-user{% endif %}" 
                             data-username="{{ user.username|lower }}" 
                             data-email="{{ user.email|lower }}" 
                             data-role="{{ user.role|lower }}"
                             data-status="{% if user.is_active %}active{% else %}blacklisted{% endif %}">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex align-items-start justify-content-between mb-3">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-lg bg-primary rounded-circle d-flex align-items-center justify-content-center me-3">
                                                <i class="bi bi-person text-white fs-4"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-1 user-name">{{ user.username }}</h6>
                                                <small class="text-muted">#{{ user.id }}</small>
                                                {% if not user.is_active %}
                                                    <div><span class="blacklisted-badge">BLACKLISTED</span></div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% if user.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-danger">Blacklisted</span>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="text-muted small mb-1">
                                            <i class="bi bi-envelope me-1"></i>{{ user.email }}
                                        </div>
                                        <div class="text-muted small mb-1">
                                            <i class="bi bi-person-badge me-1"></i>{{ user.role|title }}
                                        </div>
                                        <div class="text-muted small mb-1">
                                            <i class="bi bi-shield-check me-1"></i>
                                            {% if user.permissions.all %}
                                                {{ user.permissions.count }} permission{{ user.permissions.count|pluralize }}
                                            {% else %}
                                                No permissions
                                            {% endif %}
                                        </div>
                                        <div class="text-muted small">
                                            <i class="bi bi-people me-1"></i>
                                            {% if user.groups.all %}
                                                {{ user.groups.count }} group{{ user.groups.count|pluralize }}
                                            {% else %}
                                                No groups
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent border-top-0">
                                    <div class="d-flex gap-2">
                                        {% if user.is_active %}
                                            <button class="btn btn-outline-warning btn-sm flex-fill" 
                                                    onclick="openBlacklistModal('{{ user.email }}', '{{ user.username }}', 'blacklist')">
                                               Blacklist
                                            </button>
                                        {% else %}
                                            <button class="btn btn-outline-success btn-sm flex-fill" 
                                                    onclick="openBlacklistModal('{{ user.email }}', '{{ user.username }}', 'unblacklist')">
                                               Unblacklist
                                            </button>
                                        {% endif %}
                                        
                                        <a class="btn btn-outline-danger btn-sm flex-fill" href="{% url 'delete_user' user.id %}?next=/super/usermanagement">
                                        
                                           Delete
                                        
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% else %}
            <!-- Empty State -->
            <div class="text-center py-5">
                <i class="bi bi-people text-muted" style="font-size: 4rem;"></i>
                <h4 class="text-muted mt-3">No Users Found</h4>
                <p class="text-muted">There are no users in the system yet.</p>
            </div>
        {% endif %}
    </div>

    <!-- Blacklist/Unblacklist Modal -->
    <div class="modal fade" id="blacklistModal" tabindex="-1" aria-labelledby="blacklistModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="blacklistModalLabel">Blacklist User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="blacklistForm">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="reason_category" class="form-label">Reason Category</label>
                            <select class="form-select" id="reason_category" name="reason_category" required>
                                <option value="">Select a reason...</option>
                                <!-- Blacklist reasons -->
                                <optgroup label="Blacklist Reasons" id="blacklistReasons">
                                    <option value="invalid_docs">Blacklisted: Invalid or fake documentation</option>
                                    <option value="payment_issue">Blacklisted: Payment not received</option>
                                    <option value="fraud_suspected">Blacklisted: Fraud suspected</option>
                                    <option value="policy_violation">Blacklisted: Platform policy violation</option>
                                    <option value="inactivity">Blacklisted: Long-term inactivity</option>
                                    <option value="manual_flag">Blacklisted: Flagged after manual review</option>
                                    <option value="support_request">Blacklisted: Requested by institution</option>
                                    <option value="other_blacklist">Blacklisted: Other</option>
                                </optgroup>
                                <!-- Unblacklist reasons -->
                                <optgroup label="Unblacklist Reasons" id="unblacklistReasons" style="display: none;">
                                    <option value="resolved_docs">Unblacklisted: Valid documents provided</option>
                                    <option value="payment_received">Unblacklisted: Payment issue resolved</option>
                                    <option value="cleared">Unblacklisted: Cleared of fraudulent activity</option>
                                    <option value="policy_restored">Unblacklisted: Compliance restored</option>
                                    <option value="reinstated_by_admin">Unblacklisted: Reinstated by admin</option>
                                    <option value="appeal_successful">Unblacklisted: Successful appeal</option>
                                    <option value="support_lifted">Unblacklisted: Requested by institution</option>
                                    <option value="other_unblacklist">Unblacklisted: Other</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="reason_explanation" class="form-label">Reason Explanation</label>
                            <textarea class="form-control" id="reason_explanation" name="reason_explanation" rows="3" 
                                      placeholder="Provide additional details about the reason..." required></textarea>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <span id="actionDescription">This action will blacklist the user and restrict their access.</span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger" id="confirmActionBtn">Blacklist User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentAction = '';
        let currentUserEmail = '';
        let currentUsername = '';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            initializeViewToggle();
        });

        // Initialize event listeners
        function initializeEventListeners() {
            // Search functionality
            document.getElementById('searchUsers').addEventListener('input', filterUsers);
            
            // Filter functionality
            document.getElementById('roleFilter').addEventListener('change', filterUsers);
            document.getElementById('statusFilter').addEventListener('change', filterUsers);
            document.getElementById('sortBy').addEventListener('change', sortUsers);
            
            // View toggle
            document.getElementById('listView').addEventListener('click', () => toggleView('list'));
            document.getElementById('cardView').addEventListener('click', () => toggleView('card'));
            
            // Modal form submission
            document.getElementById('blacklistForm').addEventListener('submit', handleFormSubmission);
        }

        // Initialize view toggle
        function initializeViewToggle() {
            toggleView('list'); // Default to list view
        }

        // Toggle between list and card view
        function toggleView(viewType) {
            const listViewContainer = document.getElementById('listViewContainer');
            const cardViewContainer = document.getElementById('cardViewContainer');
            const listViewBtn = document.getElementById('listView');
            const cardViewBtn = document.getElementById('cardView');

            if (viewType === 'list') {
                listViewContainer.classList.remove('d-none');
                cardViewContainer.classList.add('d-none');
                listViewBtn.classList.add('active');
                cardViewBtn.classList.remove('active');
            } else {
                listViewContainer.classList.add('d-none');
                cardViewContainer.classList.remove('d-none');
                listViewBtn.classList.remove('active');
                cardViewBtn.classList.add('active');
            }
        }

        // Filter users based on search and filter criteria
        function filterUsers() {
            const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value.toLowerCase();

            // Filter table rows
            const tableRows = document.querySelectorAll('#usersTable tbody .user-row');
            tableRows.forEach(row => {
                const username = row.dataset.username;
                const email = row.dataset.email;
                const role = row.dataset.role;
                const status = row.dataset.status;

                const matchesSearch = !searchTerm || 
                    username.includes(searchTerm) || 
                    email.includes(searchTerm) || 
                    role.includes(searchTerm);
                
                const matchesRole = !roleFilter || role === roleFilter;
                const matchesStatus = !statusFilter || status === statusFilter;

                if (matchesSearch && matchesRole && matchesStatus) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });

            // Filter cards
            const cards = document.querySelectorAll('#usersCards .user-card');
            cards.forEach(card => {
                const username = card.dataset.username;
                const email = card.dataset.email;
                const role = card.dataset.role;
                const status = card.dataset.status;

                const matchesSearch = !searchTerm || 
                    username.includes(searchTerm) || 
                    email.includes(searchTerm) || 
                    role.includes(searchTerm);
                
                const matchesRole = !roleFilter || role === roleFilter;
                const matchesStatus = !statusFilter || status === statusFilter;

                if (matchesSearch && matchesRole && matchesStatus) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Sort users based on selected criteria
        function sortUsers() {
            const sortBy = document.getElementById('sortBy').value;
            const tableBody = document.querySelector('#usersTable tbody');
            const cardsContainer = document.getElementById('usersCards');
            
            // Sort table rows
            const rows = Array.from(tableBody.querySelectorAll('.user-row'));
            rows.sort((a, b) => {
                let aValue, bValue;
                
                switch(sortBy) {
                    case 'username':
                        aValue = a.dataset.username;
                        bValue = b.dataset.username;
                        break;
                    case 'username-desc':
                        aValue = b.dataset.username;
                        bValue = a.dataset.username;
                        break;
                    case 'role':
                        aValue = a.dataset.role;
                        bValue = b.dataset.role;
                        break;
                    case 'email':
                        aValue = a.dataset.email;
                        bValue = b.dataset.email;
                        break;
                    case 'id':
                        aValue = parseInt(a.querySelector('small').textContent.replace('#', ''));
                        bValue = parseInt(b.querySelector('small').textContent.replace('#', ''));
                        return aValue - bValue;
                    default:
                        return 0;
                }
                
                return aValue.localeCompare(bValue);
            });
            
            // Reorder table rows
            rows.forEach(row => tableBody.appendChild(row));
            
            // Sort cards
            const cards = Array.from(cardsContainer.querySelectorAll('.user-card'));
            cards.sort((a, b) => {
                let aValue, bValue;
                
                switch(sortBy) {
                    case 'username':
                        aValue = a.dataset.username;
                        bValue = b.dataset.username;
                        break;
                    case 'username-desc':
                        aValue = b.dataset.username;
                        bValue = a.dataset.username;
                        break;
                    case 'role':
                        aValue = a.dataset.role;
                        bValue = b.dataset.role;
                        break;
                    case 'email':
                        aValue = a.dataset.email;
                        bValue = b.dataset.email;
                        break;
                    case 'id':
                        aValue = parseInt(a.querySelector('small').textContent.replace('#', ''));
                        bValue = parseInt(b.querySelector('small').textContent.replace('#', ''));
                        return aValue - bValue;
                    default:
                        return 0;
                }
                
                return aValue.localeCompare(bValue);
            });
            
            // Reorder cards
            cards.forEach(card => cardsContainer.appendChild(card));
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('searchUsers').value = '';
            document.getElementById('roleFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('sortBy').value = 'username';
            filterUsers();
            sortUsers();
        }

        // Open blacklist/unblacklist modal
        function openBlacklistModal(userEmail, username, action) {
            currentAction = action;
            currentUserEmail = userEmail;
            currentUsername = username;
            
            const modal = new bootstrap.Modal(document.getElementById('blacklistModal'));
            const modalTitle = document.getElementById('blacklistModalLabel');
            const confirmBtn = document.getElementById('confirmActionBtn');
            const actionDescription = document.getElementById('actionDescription');
            const blacklistReasons = document.getElementById('blacklistReasons');
            const unblacklistReasons = document.getElementById('unblacklistReasons');
            const reason_category = document.getElementById('reason_category');
            
            // Reset form
            document.getElementById('blacklistForm').reset();
            
            if (action === 'blacklist') {
                modalTitle.textContent = `Blacklist User: ${username}`;
                confirmBtn.textContent = 'Blacklist User';
                confirmBtn.className = 'btn btn-danger';
                actionDescription.textContent = 'This action will blacklist the user and restrict their access.';
                blacklistReasons.style.display = '';
                unblacklistReasons.style.display = 'none';
            } else {
                modalTitle.textContent = `Unblacklist User: ${username}`;
                confirmBtn.textContent = 'Unblacklist User';
                confirmBtn.className = 'btn btn-warning';
                actionDescription.textContent = 'This action will unblacklist the user and restore their access.';
                blacklistReasons.style.display = 'none';
                unblacklistReasons.style.display = '';
            }
            
            modal.show();
        }

        // Handle form submission
        function handleFormSubmission(event) {
            event.preventDefault();
            
            // Get form data
            const formData = new FormData(event.target);
            
            // Prepare data for submission
            const data = {
                reason_category: formData.get('reason_category'),
                reason_explanation: formData.get('reason_explanation'),
                action: currentAction
            };
            
            // Show loading state
            const confirmBtn = document.getElementById('confirmActionBtn');
            const originalText = confirmBtn.textContent;
            confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
            confirmBtn.disabled = true;
            
            // Make API call to the correct endpoint
            const url = `/super/blacklist/${currentUserEmail}`;
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Accept': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (response.ok) {
                    return response.json().catch(() => {
                        // If JSON parsing fails, return a success object
                        return { success: true, message: 'Operation completed successfully' };
                    });
                } else {
                    // Try to get error message from response
                    return response.text().then(text => {
                        throw new Error(`HTTP ${response.status}: ${text || 'Unknown error'}`);
                    });
                }
            })
            .then(data => {
                console.log('Success response:', data);
                
                // Success - close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('blacklistModal'));
                modal.hide();
                
                // Show success message
                const actionText = currentAction === 'blacklist' ? 'blacklisted' : 'unblacklisted';
                showAlert('success', `User ${currentUsername} ${actionText} successfully!`);
                
                // Refresh page after a short delay to show updated status
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            })
            .catch(error => {
                console.error('Error details:', error);
                
                // Show error message
                const actionText = currentAction === 'blacklist' ? 'blacklist' : 'unblacklist';
                showAlert('danger', `Failed to ${actionText} user ${currentUsername}. Error: ${error.message}`);
                
                // Reset button
                confirmBtn.textContent = originalText;
                confirmBtn.disabled = false;
            });
        }

        // Get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Show alert message
        function showAlert(type, message) {
            const alertContainer = document.querySelector('.container-fluid');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                <i class="bi bi-info-circle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Insert at the top of the container
            alertContainer.insertBefore(alert, alertContainer.firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        // Edit user function (placeholder)
        

        // Export data function (placeholder)
        function exportData() {
            // This would typically generate and download a CSV or Excel file
            showAlert('info', 'Export functionality would be implemented here.');
        }
    </script>

{% endblock %}

